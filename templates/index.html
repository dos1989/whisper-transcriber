<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å»£æ±è©±èªéŸ³è½‰æ–‡å­—</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ™ï¸ å»£æ±è©±èªéŸ³è½‰æ–‡å­—</h1>
            <p class="subtitle">ä¸Šå‚³ MP3 éŒ„éŸ³ï¼Œå³æ™‚è½‰æ›æˆæ–‡å­—</p>
        </header>

        <main>
            <!-- ä¸Šå‚³å€åŸŸ -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">ğŸ“</div>
                <p class="upload-text">æ‹–æ‹½éŸ³æª”åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                <p class="upload-hint">æ”¯æ´æ ¼å¼ï¼šMP3, WAV, M4A, OGG, FLAC</p>
                <input type="file" id="fileInput" accept=".mp3,.wav,.mp4,.m4a,.ogg,.flac,.webm" hidden>
            </div>

            <!-- æª”æ¡ˆè³‡è¨Š -->
            <div class="file-info" id="fileInfo" style="display: none;">
                <span class="file-name" id="fileName"></span>
                <button class="btn-clear" id="clearBtn">âœ•</button>
            </div>

            <!-- è½‰éŒ„æŒ‰éˆ• -->
            <button class="btn-transcribe" id="transcribeBtn" disabled>
                <span class="btn-text">é–‹å§‹è½‰éŒ„</span>
                <span class="btn-loading" style="display: none;">
                    <span class="spinner"></span>
                    è™•ç†ä¸­...
                </span>
            </button>

            <!-- é€²åº¦æç¤º -->
            <div class="progress-section" id="progressSection" style="display: none;">
                <div class="progress-header">
                    <span class="progress-icon" id="progressIcon">ğŸ“¤</span>
                    <span class="progress-status" id="progressStatus">æº–å‚™ä¸­...</span>
                </div>

                <!-- ç‰‡æ®µé€²åº¦ -->
                <div class="segment-info" id="segmentInfo" style="display: none;">
                    <span id="segmentText">ç‰‡æ®µ 0/0</span>
                </div>

                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-details">
                    <span class="progress-stage" id="progressStage">éšæ®µ 1/3</span>
                    <span class="progress-percent" id="progressPercent">0%</span>
                </div>
                <div class="progress-info-text" id="progressInfoText">
                    <p id="progressMessage">æ­£åœ¨ä¸Šå‚³éŸ³æª”...</p>
                    <p class="progress-hint" id="progressHint">è«‹å‹¿é—œé–‰æ­¤é é¢</p>
                </div>
                <div class="elapsed-time" id="elapsedTime">å·²ç”¨æ™‚é–“: 0:00</div>
            </div>

            <!-- çµæœå€åŸŸ -->
            <div class="result-section" id="resultSection" style="display: none;">
                <h2>ğŸ“ è½‰éŒ„çµæœ</h2>
                <div class="result-box">
                    <textarea id="resultText" readonly></textarea>
                </div>
                <div class="result-actions">
                    <button class="btn-copy" id="copyBtn">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
                    <button class="btn-download" id="downloadBtn">â¬‡ï¸ ä¸‹è¼‰ TXT</button>
                </div>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div class="error-message" id="errorMessage" style="display: none;"></div>
        </main>

        <footer>
            <p>ä½¿ç”¨ OpenAI Whisper æŠ€è¡“ | æœ¬åœ°è™•ç†ï¼Œä¿è­·ç§éš±</p>
        </footer>
    </div>

    <script>
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const clearBtn = document.getElementById('clearBtn');
        const transcribeBtn = document.getElementById('transcribeBtn');
        const progressSection = document.getElementById('progressSection');
        const progressIcon = document.getElementById('progressIcon');
        const progressStatus = document.getElementById('progressStatus');
        const progressBar = document.getElementById('progressBar');
        const progressStage = document.getElementById('progressStage');
        const progressPercent = document.getElementById('progressPercent');
        const progressMessage = document.getElementById('progressMessage');
        const progressHint = document.getElementById('progressHint');
        const elapsedTimeEl = document.getElementById('elapsedTime');
        const segmentInfo = document.getElementById('segmentInfo');
        const segmentText = document.getElementById('segmentText');
        const resultSection = document.getElementById('resultSection');
        const resultText = document.getElementById('resultText');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const errorMessage = document.getElementById('errorMessage');

        let selectedFile = null;
        let downloadId = null;
        let elapsedTimer = null;
        let startTime = null;

        // æ ¼å¼åŒ–æ™‚é–“
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // é–‹å§‹è¨ˆæ™‚
        function startElapsedTimer() {
            startTime = Date.now();
            elapsedTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                elapsedTimeEl.textContent = `å·²ç”¨æ™‚é–“: ${formatTime(elapsed)}`;
            }, 1000);
        }

        // åœæ­¢è¨ˆæ™‚
        function stopElapsedTimer() {
            if (elapsedTimer) {
                clearInterval(elapsedTimer);
                elapsedTimer = null;
            }
        }

        // æ›´æ–°é€²åº¦é¡¯ç¤º
        function updateProgress(percent, icon, status, message, hint, stage = null) {
            progressIcon.textContent = icon;
            progressStatus.textContent = status;
            progressBar.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            progressMessage.textContent = message;
            if (hint) progressHint.textContent = hint;
            if (stage) progressStage.textContent = stage;
        }

        // é¡¯ç¤ºç‰‡æ®µé€²åº¦
        function showSegmentProgress(current, total) {
            segmentInfo.style.display = 'block';
            segmentText.textContent = `ç‰‡æ®µ ${current}/${total}`;
        }

        // é»æ“Šä¸Šå‚³å€åŸŸ
        uploadZone.addEventListener('click', () => fileInput.click());

        // æ‹–æ‹½äº‹ä»¶
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        // æª”æ¡ˆé¸æ“‡
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            selectedFile = file;
            fileName.textContent = `${file.name} (${formatFileSize(file.size)})`;
            fileInfo.style.display = 'flex';
            uploadZone.style.display = 'none';
            transcribeBtn.disabled = false;
            hideError();
            hideResult();
        }

        // æ¸…é™¤æª”æ¡ˆ
        clearBtn.addEventListener('click', () => {
            resetUpload();
        });

        function resetUpload() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadZone.style.display = 'flex';
            transcribeBtn.disabled = true;
            segmentInfo.style.display = 'none';
        }

        // é–‹å§‹è½‰éŒ„
        transcribeBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const btnText = transcribeBtn.querySelector('.btn-text');
            const btnLoading = transcribeBtn.querySelector('.btn-loading');

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline-flex';
            transcribeBtn.disabled = true;
            progressSection.style.display = 'block';
            segmentInfo.style.display = 'none';
            hideError();
            hideResult();

            // é–‹å§‹è¨ˆæ™‚
            startElapsedTimer();

            // éšæ®µ 1: ä¸Šå‚³
            updateProgress(0, 'ğŸ“¤', 'ä¸Šå‚³ä¸­', `æ­£åœ¨ä¸Šå‚³ ${selectedFile.name}...`, 'è«‹å‹¿é—œé–‰æ­¤é é¢', 'éšæ®µ 1/3 - ä¸Šå‚³');

            try {
                // ä¸Šå‚³æª”æ¡ˆ
                const formData = new FormData();
                formData.append('audio', selectedFile);

                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const uploadData = await uploadResponse.json();

                if (!uploadData.success) {
                    throw new Error(uploadData.error || 'ä¸Šå‚³å¤±æ•—');
                }

                const fileId = uploadData.file_id;
                const totalSegments = uploadData.segment_count;
                downloadId = fileId;

                updateProgress(10, 'ğŸ“¤', 'ä¸Šå‚³å®Œæˆ', 'æª”æ¡ˆå·²ä¸Šå‚³ï¼Œæº–å‚™é–‹å§‹è½‰éŒ„...',
                    totalSegments > 1 ? `å°‡åˆ†æˆ ${totalSegments} å€‹ç‰‡æ®µè™•ç†` : 'å–®ä¸€ç‰‡æ®µè™•ç†',
                    'éšæ®µ 2/3 - è™•ç†');

                // éšæ®µ 2: ä½¿ç”¨ SSE æ¥æ”¶è½‰éŒ„é€²åº¦
                const eventSource = new EventSource(`/transcribe/${fileId}`);

                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    if (data.error) {
                        eventSource.close();
                        showError(data.error);
                        resetUI();
                        return;
                    }

                    // æ›´æ–°é€²åº¦
                    const progress = data.progress || 0;

                    if (data.stage === 'splitting') {
                        updateProgress(progress, 'âœ‚ï¸', 'åˆ†å‰²ä¸­', data.message, 'æ­£åœ¨åˆ†å‰²é•·éŒ„éŸ³...', 'éšæ®µ 2/3 - åˆ†å‰²');
                    }
                    else if (data.stage === 'transcribing') {
                        const currentSeg = data.current_segment || 0;
                        const totalSeg = data.total_segments || 1;
                        showSegmentProgress(currentSeg, totalSeg);
                        updateProgress(progress, 'ğŸ™ï¸', 'è½‰éŒ„ä¸­', data.message,
                            `ç¬¬ ${currentSeg}/${totalSeg} å€‹ç‰‡æ®µ`,
                            `éšæ®µ 2/3 - è½‰éŒ„ (${currentSeg}/${totalSeg})`);
                    }
                    else if (data.stage === 'finalizing') {
                        updateProgress(progress, 'ğŸ“', 'è™•ç†ä¸­', data.message, 'å³å°‡å®Œæˆ...', 'éšæ®µ 3/3 - å®Œæˆ');
                    }
                    else if (data.stage === 'complete') {
                        eventSource.close();
                        updateProgress(100, 'âœ…', 'å®Œæˆï¼', 'è½‰éŒ„æˆåŠŸï¼', 'å¯ä»¥æŸ¥çœ‹å’Œä¸‹è¼‰çµæœ', 'å®Œæˆ');

                        // é¡¯ç¤ºçµæœ
                        setTimeout(() => {
                            resultText.value = data.transcript;
                            downloadId = data.download_id;
                            resultSection.style.display = 'block';
                            progressSection.style.display = 'none';
                            resetUI();
                        }, 500);
                    }
                };

                eventSource.onerror = () => {
                    eventSource.close();
                    showError('é€£ç·šä¸­æ–·ï¼Œè«‹é‡è©¦');
                    resetUI();
                };

            } catch (error) {
                showError(error.message || 'è™•ç†å¤±æ•—');
                resetUI();
            }
        });

        function resetUI() {
            stopElapsedTimer();
            const btnText = transcribeBtn.querySelector('.btn-text');
            const btnLoading = transcribeBtn.querySelector('.btn-loading');
            btnText.style.display = 'inline';
            btnLoading.style.display = 'none';
            transcribeBtn.disabled = false;
        }

        // è¤‡è£½æ–‡å­—
        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(resultText.value);
                copyBtn.textContent = 'âœ… å·²è¤‡è£½';
                setTimeout(() => {
                    copyBtn.textContent = 'ğŸ“‹ è¤‡è£½æ–‡å­—';
                }, 2000);
            } catch (error) {
                showError('è¤‡è£½å¤±æ•—');
            }
        });

        // ä¸‹è¼‰ TXT - è®“ç”¨æˆ¶é¸æ“‡å„²å­˜ä½ç½®
        downloadBtn.addEventListener('click', async () => {
            const content = resultText.value;
            if (!content) return;

            // å˜—è©¦ä½¿ç”¨ File System Access APIï¼ˆè®“ç”¨æˆ¶é¸æ“‡å„²å­˜ä½ç½®ï¼‰
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'è½‰éŒ„çµæœ.txt',
                        types: [{
                            description: 'Text Files',
                            accept: { 'text/plain': ['.txt'] }
                        }]
                    });
                    const writable = await handle.createWritable();
                    await writable.write(content);
                    await writable.close();

                    downloadBtn.textContent = 'âœ… å·²å„²å­˜';
                    setTimeout(() => {
                        downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰ TXT';
                    }, 2000);
                    return;
                } catch (err) {
                    // ç”¨æˆ¶å–æ¶ˆæˆ–ç™¼ç”ŸéŒ¯èª¤ï¼Œä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆ
                    if (err.name === 'AbortError') return;
                }
            }

            // å‚™ç”¨æ–¹æ¡ˆï¼šæç¤ºç”¨æˆ¶è¼¸å…¥æª”åå¾Œä¸‹è¼‰
            const filename = prompt('è«‹è¼¸å…¥æª”æ¡ˆåç¨±ï¼š', 'è½‰éŒ„çµæœ') || 'è½‰éŒ„çµæœ';
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            progressSection.style.display = 'none';
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function hideResult() {
            resultSection.style.display = 'none';
        }
    </script>
</body>

</html>